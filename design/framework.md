# 前言
本篇幅先介绍传统的代码发布系统的做法，引申出传统做法的不足，然后介绍 CodePub 的架构，优势和解决的问题.

# 传统的发布系统架构
传统的代码发布系统有很多, 典型的代表是 Jenkins、Walle(瓦力)等。当然了 Jenkins 不只是代码发布系统，同样也是持续集成、持续部署、自动化构建的系统  
他们发布机制：核心都是 ssh 协议  

我们以最常用的 Walle 瓦力发布来举例说明它的实现原理：

![瓦力](./images/walle-flow-relation.jpg)

整个代码发布系统由宿主机和目标机器组成。

1. 拉取代码到到宿主机服务器上
2. 对比发版前后的变化的文件
3. 把代码文件通过 ssh 协议推送到目标服务器上

正是由于它的这种架构，决定了很多问题是无法避免的，比如:  
1. 宿主机和目标机群需要维护 ssh-key，如果部署大量的机器和项目，ssh-key 的管理将会让人头疼
2. 推送代码到目标服务器和执行目标服务器脚本一般需要依赖软件，例如 rsync, Walle 用的是 Ansible，一个非常强大的运维自动化部署工具
3. 如果多个部门共用代码发布系统，使用率很高，那么频繁的大量的本地拉取操作会导致宿主机服务器 I/O 延迟明显增大，导致宿主机反应过慢，影响系统稳定性
4. 即使很少量的文件变动，依然还是 拉取->对比->ssh推送，这个流程相对来说比较耗费时间
5. 非 Linux 系统是无法发布代码的，比如 Windows 是没有 ssh 的，只能依靠辅助软件来实现，增加部署维护成本

# CodePub架构
架构核心思想：去除中心、简化配置、快速发布、使用简单

- 去除中心：去除了传统代码发布系统的宿主机的角色，不再支撑频繁的代码拉去和对比工作
- 简化配置：目标服务器不再需要配置任何的 ssh-key，只需要安装 agent 程序一键启动就OK
- 快速发布：agent 节点程序内置实现了 ssh 协议，直接将代码从 git 库中拉取，提高代码发布效率
- 使用简单：安装程序自动化，仅需要 Mysql 数据库支持，一键安装发布系统后台

基于 `M(管理中心)/A(节点)` 的架构：

![codepub](./images/codepub.png)

这种架构决定了可以快速的通信，管理中心只负责发送指令给 agent，然后agent执行具体操作.
如果是N个agent节点，管理中心是并发的发送指令,这样无论多少agent节点,发布的时间是不会变长的.
下面重点说一下agent执行git操作的过程,首先指令里面发送的主要是要发布的:branch\tag\commit_id这三个东西的一种.

agent收到指令后会:
- 1.首先fetch远程代码.
- 2.根据发布的`branch\tag\commit_id`获取要发布的最终commit_id,
- 3.然后`最终commit_id`在本地新建一个auto开头的分支,并`强制`检出这个分支,`强制意味着所有的本地修改都会被清除`,然后删除本地其它分支.

可以看到agent进行的是纯git操作,效率是很高的,对比ssh的方式时间上不是一个量级的.    
提示:  
agent内部实现了git协议和ssh协议,git操作不依赖系统的git命令,ssh也不依赖系统的ssh命令和配置.所以系统的git和ssh配置对agent没有任何影响和作用.
